---
title: "5. Программные интерфейсы (API)"
icon: "Share2"
prevButtonText: "К техническим требованиям"
nextButtonText: "К процедуре приемки"
---

### 5. Программные интерфейсы (API)
Этот раздел определяет структуру данных и "контракты" взаимодействия между модулями системы. Он служит основой для разработки и интеграции всех микросервисов.

#### 5.1. Модели данных (C5 - Level 4: Crumbs)
Ключевые сущности системы, которые будут представлены в базе данных PostgreSQL и транслироваться через API.

*   `Tenants` (Партнеры): Хранит информацию о White-Label партнерах, включая их настройки брендинга.
*   `Clients` (Клиенты): Пользователи, заказывающие кампании. Привязаны к `Tenants`.
*   `Projects` (Проекты): Основная рабочая сущность. Содержит все входные данные из квиза и отслеживает прогресс по цели.
*   `Influencers` (Инфлюенсеры): База инфлюенсеров с их метриками, контактами и семантическим вектором для поиска.
*   `Campaigns` (Кампании): Запись об отправке сообщений конкретному инфлюенсеру в рамках проекта. Отслеживает статус коммуникации.


```mermaid
erDiagram
    TENANT ||--|{ CLIENT : "имеет"
    CLIENT ||--|{ PROJECT : "заказывает"
    PROJECT ||--|{ CAMPAIGN : "включает"
    INFLUENCER ||--|{ CAMPAIGN : "участвует в"

    TENANT {
        int id PK "Tenant ID"
        string name
        string custom_domain
        json branding_settings
    }
    CLIENT {
        int id PK
        string name
        string email
        string stripe_customer_id
        int tenant_id FK
    }
    PROJECT {
        int id PK
        int client_id FK
        string status "pending, active, completed, failed"
        int target_replies
        int current_replies
        json prompt_data "Данные из квиза"
    }
    INFLUENCER {
        int id PK
        string handle
        string platform
        string email
        int followers
        vector bio_vector "Для семантического поиска"
    }
    CAMPAIGN {
        int id PK
        int project_id FK
        int influencer_id FK
        string status "sent, replied, positive, negative"
        timestamp last_sent_at
    }
```

#### 5.2. Ключевые процессы и API-взаимодействия (C5 - Level 3: Chunks)
Описание основных API-эндпоинтов, обеспечивающих работу пользовательских сценариев.

**5.2.1. Ядро API (Payload CMS)**
*   `POST /api/projects`: Создание нового проекта. Принимает данные из квиза, создает клиента (если новый), обрабатывает платеж через Stripe.
*   `GET /api/projects/:id`: Получение статуса и деталей проекта (для личного кабинета клиента).
*   `POST /api/projects/:id/start`: Внутренний эндпоинт для запуска проекта (триггерит вызовы к AI и Outreach сервисам).

**5.2.2. Сервис подбора и генерации (AI Service)**
*   `POST /api/match`: Принимает `prompt_data` из проекта. Возвращает массив `influencer_id`, отфильтрованных и отсортированных по релевантности.
*   `POST /api/generate`: Принимает `prompt_data` и один `influencer_id`. Возвращает готовую персонализированную email-цепочку.

**5.2.3. Сервис рассылок (Outreach Service)**
*   `POST /api/campaigns/start`: Принимает массив объектов `{influencer_id, email_sequence}`. Начинает рассылку.
*   `POST /api/campaigns/stop`: Останавливает все рассылки, связанные с указанным `project_id`.
*   `POST /api/webhooks/reply`: Внутренний эндпоинт, который вызывается при обнаружении ответа в почтовом ящике. Запускает классификацию и уведомляет Ядро API.


```mermaid
sequenceDiagram
    participant IMAP as "IMAP Listener"
    participant Outreach as "Outreach Service"
    participant Classifier as "AI Classifier"
    participant Core as "Ядро API"
    participant Notify as "Notification Service"

    IMAP->>Outreach: 1. Обнаружен новый email (ответ)
    Outreach->>Classifier: 2. Классифицировать текст ответа
    Classifier-->>Outreach: 3. Результат: "Позитивный"
    Outreach->>Core: 4. POST /api/webhooks/project-update (project_id, influencer_id, status: positive)
    Core->>Core: 5. Обновляет счетчик в Проекте
    Core->>Notify: 6. Триггер на отправку уведомления
```

#### 5.3. Принципы проектирования API
Все API в системе должны следовать единым правилам для обеспечения консистентности и простоты интеграции.
*   **Стиль:** RESTful.
*   **Формат данных:** JSON (camelCase для ключей).
*   **Аутентификация:** Все запросы к внутренним API защищены с помощью Bearer-токенов (JWT) или API-ключей.
*   **Обработка ошибок:** Используются стандартные HTTP-коды состояния (200, 201, 400, 401, 403, 404, 500). Тело ответа при ошибке содержит `{ "error": { "code": "ERROR_CODE", "message": "Human-readable message" } }`.
*   **Версионирование:** Путь к API включает номер версии (например, `/api/v1/...`) для обеспечения обратной совместимости в будущем.
